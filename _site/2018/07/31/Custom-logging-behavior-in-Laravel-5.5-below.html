<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title> Laravel 5.5 以下版本中自定义日志行为 </title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1> 麦索的麦田 </h1>
        <h2>Nothing is impossible</h2>
        <a href="/" class="button"><small>go back</small>Index</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          
          <h2>Laravel 5.5 以下版本中自定义日志行为</h2>
<p class="meta">2018-07-31</p>

<p>在 Laravel 5.6 版本中日志行为可以很容易的进行自定义，而在5.5以下版本中日志行为自定义自由度并不是很高，但是项目有需求不能因为这个就强行将项目升级为5.6吧，况且作为一个稳定的项目升级框架大版本有可能会有很多坑，基于这些原因我尝试了对 Laravel 5.5 的日志进行改造以适应我的需求。</p>

<p>Laravel 的日志行为大部分是在 <code class="highlighter-rouge">Illuminate\Log\LogServiceProvider</code> 中，我们可以看一下其中的代码片段：</p>

<pre><code class="language-PHP">/**
 * Configure the Monolog handlers for the application.
 *
 * @param  \Illuminate\Log\Writer  $log
 * @return void
 */
protected function configureDailyHandler(Writer $log)
{
    $log-&gt;useDailyFiles(
        $this-&gt;app-&gt;storagePath().'/logs/laravel.log', $this-&gt;maxFiles(),
        $this-&gt;logLevel()
    );
}
</code></pre>

<p>这是我最常在项目中使用的日志存储方式，可以看到日志的存储路径几近与写死的状态，无法通过外部参数轻易的更改。</p>

<p>最开始我想的是重写这个 <code class="highlighter-rouge">Provider</code> 然后将其注册到 <code class="highlighter-rouge">app.php</code> 的 <code class="highlighter-rouge">providers</code> 数组中，但是这种行为并不可行，因为通过查看源码，<code class="highlighter-rouge">LogServiceProvider</code> 是在框架启动时就注册。</p>

<p>在 中有这样一个方法控制了这个注册行为：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="nf">registerBaseServiceProviders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">EventServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">RoutingServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>既然我们知道了它们是如何生效的，那么我们将这两个类继承并修改其中我们需要改变的行为进行改造，我的改造方式如下。在<code class="highlighter-rouge">app\Providers</code>中新建<code class="highlighter-rouge">LogServiceProvider</code>类继承<code class="highlighter-rouge">Illuminate\Log\LogServiceProvider</code>，代码如下：</p>

<pre><code class="language-PHP">&lt;?php


namespace App\Providers;

use Illuminate\Log\LogServiceProvider as BaseLogServiceProvider;
use Illuminate\Log\Writer;

class LogServiceProvider extends BaseLogServiceProvider
{
    /**
     * Configure the Monolog handlers for the application.
     *
     * @param  \Illuminate\Log\Writer  $log
     * @return void
     */
    protected function configureDailyHandler(Writer $log)
    {
        $path = config('app.log_path');
        $log-&gt;useDailyFiles(
            $path, $this-&gt;maxFiles(),
            $this-&gt;logLevel()
        );
    }
}
</code></pre>

<p>在<code class="highlighter-rouge">config/app.php</code>目录中添加配置：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'log_path' =&gt; env('APP_LOG_PATH', storage_path('/logs/laravel.log')),
</code></pre></div></div>

<p><code class="highlighter-rouge">app</code>目录中新建<code class="highlighter-rouge">Foundation</code>目录，新建<code class="highlighter-rouge">Application</code>类继承<code class="highlighter-rouge">Illuminate\Foundation\Application</code>类，重写<code class="highlighter-rouge">registerBaseServiceProviders</code>方法。</p>

<pre><code class="language-PHP">&lt;?php
/**
 * Created by PhpStorm.
 * User: dongyuxiang
 * Date: 2018/7/31
 * Time: 16:53
 */

namespace App\Foundation;

use App\Providers\LogServiceProvider;
use Illuminate\Events\EventServiceProvider;
use Illuminate\Routing\RoutingServiceProvider;
use Illuminate\Foundation\Application as BaseApplication;


class Application extends BaseApplication
{

    /**
     * Register all of the base service providers.
     *
     * @return void
     */
    protected function registerBaseServiceProviders()
    {
        $this-&gt;register(new EventServiceProvider($this));

        $this-&gt;register(new LogServiceProvider($this));

        $this-&gt;register(new RoutingServiceProvider($this));
    }

}
</code></pre>

<p>说是重写其实只是将use类换从了我们自己创建的<code class="highlighter-rouge">LogServiceProvider</code>。</p>

<p>然后在<code class="highlighter-rouge">bootstrap\app.php</code>中将变量<code class="highlighter-rouge">$app</code>的<code class="highlighter-rouge">new</code>对象换成我们继承重写后的。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$app = new App\Foundation\Application(
    realpath(__DIR__.'/../')
);
</code></pre></div></div>

<p>这样我就成功的将日志路径可以随便定义了，而且来说有了这次经验我对于框架不符合我需求的地方可以做更进一步的优化以符合我的要求，而且我没有更改框架底层的代码，当框架有bug修复的时候我也可以放心的进行框架更新。</p>



<!--PC和WAP自适应版-->
<div id="SOHUCS" sid="Laravel 5.5 以下版本中自定义日志行为" ></div>
<script type="text/javascript">
(function(){
var appid = 'cyt8K3bay';
var conf = 'prod_4cce8456a31ddba41cd9cd6ae71a8ee7';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>


        </section>

        <aside id="sidebar">
          <!--<a href="https://github.com/pietromenna/jekyll-architect-theme/archive/master.zip" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/pietromenna/jekyll-architect-theme/archive/master.tar.gz" class="button">
            <small>Download</small>
            .tar.gz file
          </a>-->

          <p class="repo-owner"><a href="https://github.com/jasonlong/architect-theme">architect-theme</a> is maintained by <a href="https://github.com/jasonlong">jasonlong</a>.</p>

          <p class="repo-owner"><a href="https://github.com/pietromenna/jekyll-architect-theme">jekyll-architect-theme</a> is maintained by <a href="https://github.com/pietromenna">pietromenna</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
